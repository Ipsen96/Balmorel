** Allocation of the inflow time series to the different power plants

* max natural inflow to ROR plants installed capacity 2020 times 168. For ROR in river systems multiply again with .8
* the rest is allocated to Short FLEX and RIVER_STORAGE according to annual inflow

*
ALIAS(G,IGALIAS2);
PARAMETERS
IHYDROCAS_INFLOWFACTOR(AAA,GGG,IGGGALIAS)
IHYINFNAT_S(AAA,GGG,SSS)
IHYINFUPSTREAM_S(AAA,GGG,SSS)
IHYINFNAT_SLOOP(SSS)
IHYINFUNREG_S(AAA,GGG,SSS)
IHYINFANN(AAA,GGG) 'annual inflow factor (FLH)'
IHYINFANN_UNREG(AAA,GGG) 'annual inflow factor (FLH) for unregulated inflow'
IHYINFANN_UPSTREAM(AAA,GGG) 'annual inflow factor (FLH) for unregulated inflow'

IHIGHUNREGSEASONS(AAA,GGG,SSS) 'seasons with high unregulated inflow'
;

GKFX(YYY,IA,G)$(SUM(HYDROCAS_CCC, ICA(HYDROCAS_CCC,IA)) AND ((GDATA(G,'GDTYPE') EQ GHYRS) OR (GDATA(G,'GDTYPE') EQ GHYRR))) = 0;
GKFX(YYY,IA,G)$SUM(HYDROCAS_CCC, ICA(HYDROCAS_CCC,IA)) = GKFX(YYY,IA,G) + HYDROCAS_GKFX(IA,G,YYY);
IAGK_HYDRCAS(IA,G)$(SUM(HYDROCAS_CCC, ICA(HYDROCAS_CCC,IA)) AND (IGHYRS(G) OR IGHYRR(G))) = YES$(SUM(Y, GKFX(Y,IA,G)) OR AGKN(IA,G));


SET IA_HYDROCASG(AAA) 'areas with hydro inflow determined on a technology level'; IA_HYDROCASG(IA) = YES$SUM((G,SSS)$IAGK_HYDRCAS(IA,G), WTR_REG_VARSG(G,SSS)  + WTR_UNREG_VARSG(G,SSS));



** factor for inflow from all upstream power plants (2 steps max with this formulation)
IHYDROCAS_INFLOWFACTOR(IA,G,IGALIAS)$(IAGK_HYDRCAS(IA,G) AND IAGK_HYDRCAS(IA,IGALIAS)) = HYDROCAS_TRANSFER(IA,G,IGALIAS) +  SUM(IGALIAS2$IAGK_HYDRCAS(IA,IGALIAS2), HYDROCAS_TRANSFER(IA,G,IGALIAS2) * HYDROCAS_TRANSFER(IA,IGALIAS2,IGALIAS));


IHYINFANN(IA,G)$IAGK_HYDRCAS(IA,G)          =   HDATA(G,'HDINFLOW')*(1$(NOT INLFOWADJUST(IA)) + INLFOWADJUST(IA)) ;
IHYINFANN_UNREG(IA,G)$IAGK_HYDRCAS(IA,G)    =   HDATA(G,'HDINFLOWUREG')*(1$(NOT INLFOWADJUST(IA)) + INLFOWADJUST(IA)) ;
IHYINFANN_UPSTREAM(IA,G)$IAGK_HYDRCAS(IA,G) =   HDATA(G,'HDINFLOWUPSTREAM')*(1$(NOT INLFOWADJUST(IA)) + INLFOWADJUST(IA)) ;


IHYINFNAT_S(IA,G,SSS)$(IAGK_HYDRCAS(IA,G) AND IHYINFANN(IA,G))                   = WTR_REG_VARSG(G,SSS)      * GKFX('2020',IA,G) * (IHYINFANN(IA,G)/1000)          / SUM(SSSALIAS, WTR_REG_VARSG(G,SSSALIAS))  ;
IHYINFUPSTREAM_S(IA,G,SSS)$(IAGK_HYDRCAS(IA,G) AND IHYINFANN_UPSTREAM(IA,G))     = WTR_UPSTREAM_VARSG(G,SSS) * GKFX('2020',IA,G) * (IHYINFANN_UPSTREAM(IA,G)/1000) / SUM(SSSALIAS, WTR_UPSTREAM_VARSG(G,SSSALIAS));
IHYINFUNREG_S(IA,G,SSS)$(IAGK_HYDRCAS(IA,G) AND HDATA(G,'HDINFLOWUREG'))         = WTR_UNREG_VARSG(G,SSS)    * GKFX('2020',IA,G) * (IHYINFANN_UNREG(IA,G)/1000)    / SUM(SSSALIAS, WTR_UNREG_VARSG(G,SSSALIAS));

*** Calculate inflow relative to installed capacity
IHYINFNAT_S(IA,G,SSS)$IAGK_HYDRCAS(IA,G) = IHYINFNAT_S(IA,G,SSS) * 1000 / GKFX('2020',IA,G);
IHYINFUPSTREAM_S(IA,G,SSS)$IAGK_HYDRCAS(IA,G) = IHYINFUPSTREAM_S(IA,G,SSS) * 1000 / GKFX('2020',IA,G);
IHYINFUNREG_S(IA,G,SSS)$(IAGK_HYDRCAS(IA,G)) = IHYINFUNREG_S(IA,G,SSS) * 1000    / GKFX('2020',IA,G);

IHIGHUNREGSEASONS(IA,G,S)$(IAGK_HYDRCAS(IA,G) AND IGHYRS(G)) = 1$(((1$(NOT HYDROCAS_RATES(IA,G,S)) + HYDROCAS_RATES(IA,G,S))*(CARD(HSEG)-1)/CARD(HSEG)) < IHYINFUNREG_S(IA,G,S) / CARD(TTT))     ;

** Scale according to number of time segments:
$ifi %timeaggr%==YES IHYINFNAT_S(IA,G,S)$(IAGK_HYDRCAS(IA,G) AND IGHYRS(G) AND NOT HDATA(G,'HDTYPE') EQ FLEX)     = Sum(SSS,  PS2SSS(S,SSS)*IHYINFNAT_S(IA,G,SSS))/COUNTELEMENTS(S);
$ifi %timeaggr%==YES IHYINFUNREG_S(IA,G,S)$IAGK_HYDRCAS(IA,G)  = Sum(SSS,  PS2SSS(S,SSS)*IHYINFUNREG_S(IA,G,SSS))/COUNTELEMENTS(S);
$ifi %timeaggr%==YES IHYINFUPSTREAM_S(IA,G,S)$(IAGK_HYDRCAS(IA,G) AND IGHYRS(G) AND IHYINFANN_UPSTREAM(IA,G) AND NOT HDATA(G,'HDTYPE') EQ FLEX)     = Sum(SSS,  PS2SSS(S,SSS)*IHYINFUPSTREAM_S(IA,G,SSS))/COUNTELEMENTS(S);

$ifi NOT %timeaggr%==YES IHYINFNAT_S(IA,G,S)$(IHYINFNAT_S(IA,G,S) AND IAGK_HYDRCAS(IA,G))              = IHYINFNAT_S(IA,G,S)*SUM(SSSALIAS, IHYINFNAT_S(IA,G,SSSALIAS))/SUM(ISALIAS, IHYINFNAT_S(IA,G,ISALIAS));
$ifi NOT %timeaggr%==YES IHYINFUPSTREAM_S(IA,G,S)$(IHYINFUPSTREAM_S(IA,G,S) AND IAGK_HYDRCAS(IA,G))    = IHYINFUPSTREAM_S(IA,G,S)*SUM(SSSALIAS, IHYINFUPSTREAM_S(IA,G,SSSALIAS))/SUM(ISALIAS, IHYINFUPSTREAM_S(IA,G,ISALIAS));
$ifi NOT %timeaggr%==YES IHYINFUNREG_S(IA,G,S)$(IHYINFUNREG_S(IA,G,S) AND IAGK_HYDRCAS(IA,G))          = IHYINFUNREG_S(IA,G,S)*SUM(SSSALIAS, IHYINFUNREG_S(IA,G,SSSALIAS))/SUM(ISALIAS, IHYINFUNREG_S(IA,G,ISALIAS));

































$ONTEXT
** adjustment of inflow time series (GWh) to assumed inflow. Linear adjustment of both time series.
WTR_REG_VARS(IA,SSS)$(IA_HYDROCASA(IA) AND SUM(G, IAGK_HYDRCAS(IA,G))) =  WTR_REG_VARS(IA,SSS)
                                                         * SUM(G$(HDATA(G,'HDINFLOW') + HDATA(G,'HDINFLOWUREG') + HDATA(G,'HDINFLOWUPSTREAM')), GKFX('2020',IA,G) * (IHYINFANN(IA,G) + IHYINFANN_UNREG(IA,G) + IHYINFANN_UPSTREAM(IA,G))/1000 + SUM(IGALIAS$(HDATA(G,'HDINFLOW') + HDATA(G,'HDINFLOWUREG') + HDATA(G,'HDINFLOWUPSTREAM')),IHYDROCAS_INFLOWFACTOR(IA,G,IGALIAS) * GKFX('2020',IA,IGALIAS) * (IHYINFANN(IA,G) + IHYINFANN_UNREG(IA,G) + IHYINFANN_UPSTREAM(IA,G))/1000))
                                                         / SUM(SSSALIAS,(WTR_REG_VARS(IA,SSSALIAS) + WTR_UNREG_VARS(IA,SSSALIAS)))  ;
WTR_UNREG_VARS(IA,SSS)$(IA_HYDROCASA(IA) AND SUM(G, IAGK_HYDRCAS(IA,G))) =  WTR_UNREG_VARS(IA,SSS)
                                                         * SUM(G$(HDATA(G,'HDINFLOW') + HDATA(G,'HDINFLOWUREG') + HDATA(G,'HDINFLOWUPSTREAM')), GKFX('2020',IA,G) * (IHYINFANN(IA,G) + IHYINFANN_UNREG(IA,G) + IHYINFANN_UPSTREAM(IA,G))/1000 + SUM(IGALIAS$(HDATA(G,'HDINFLOW') + HDATA(G,'HDINFLOWUREG') + HDATA(G,'HDINFLOWUPSTREAM')),IHYDROCAS_INFLOWFACTOR(IA,G,IGALIAS) * GKFX('2020',IA,IGALIAS) * (IHYINFANN(IA,G) + IHYINFANN_UNREG(IA,G) + IHYINFANN_UPSTREAM(IA,G))/1000))
                                                         / SUM(SSSALIAS,(WTR_REG_VARS(IA,SSSALIAS) + WTR_UNREG_VARS(IA,SSSALIAS))) ;
WTR_UPSTREAM_VARS(IA,SSS)$(IA_HYDROCASA(IA) AND SUM(G, IAGK_HYDRCAS(IA,G))) =  WTR_UPSTREAM_VARS(IA,SSS)
                                                         * SUM(G$(HDATA(G,'HDINFLOWUPSTREAM')), GKFX('2020',IA,G) * (IHYINFANN_UPSTREAM(IA,G))/1000 )
                                                         / SUM(SSSALIAS,WTR_UPSTREAM_VARS(IA,SSSALIAS))  ;


** PURE ROR HYDRO: Inflow adjusted so that it fits with HDINFLOW and does not violate production capacity
IHYINFUNREG_S(IA,G,SSS)$(IA_HYDROCASA(IA) AND IAGK_HYDRCAS(IA,G) AND HDATA(G,'HDINFLOWUREG'))
         = WTR_UNREG_VARS(IA,SSS) * GKFX('2020',IA,G) * (HDATA(G,'HDINFLOWUREG')/1000) / SUM(SSSALIAS, WTR_UNREG_VARS(IA,SSSALIAS)) ;
IHYINFUNREG_S(IA,G,SSS)$(IA_HYDROCASA(IA) AND IHYINFUNREG_S(IA,G,SSS)$(IAGK_HYDRCAS(IA,G) AND HDATA(G,'HDINFLOWUREG')) > GKFX('2020',IA,G)*CARD(TTT)/1000)
         = GKFX('2020',IA,G)*CARD(TTT)/1000;

* loop to adjust so inflow is at right amount while not violate capacity
PARAMETER COUNTER(AAA,GGG);   COUNTER(IA,G)$IAGK_HYDRCAS(IA,G) = 0;
LOOP((IA,G)$(IA_HYDROCASA(IA) AND IAGK_HYDRCAS(IA,G) AND  ((HDATA(G,'HDTYPE') EQ RIVER) OR (HDATA(G,'HDTYPE') EQ RIVER_STORAGE)) AND HDATA(G,'HDINFLOWUREG')),
         IHYINFNAT_SLOOP(SSS) = IHYINFUNREG_S(IA,G,SSS);
         WHILE(  SUM(SSSALIAS, IHYINFNAT_SLOOP(SSSALIAS)) LT GKFX('2020',IA,G) * HDATA(G,'HDINFLOWUREG')/1000,
                 IHYINFNAT_SLOOP(SSS) = IHYINFNAT_SLOOP(SSS)*1.01;
                 IHYINFNAT_SLOOP(SSS)$(IHYINFNAT_SLOOP(SSS) > GKFX('2020',IA,G)*CARD(TTT)/1000) = GKFX('2020',IA,G)*CARD(TTT)/1000;
                 Counter(IA,G) = Counter(IA,G) + 1;
         );
         IHYINFUNREG_S(IA,G,SSS) = IHYINFNAT_SLOOP(SSS);
);

** Calculate remaining inflow in area (deduct pure ror hydro)
WTR_UNREG_VARS(IA,SSS)$(IA_HYDROCASA(IA) AND SUM(G, IAGK_HYDRCAS(IA,G))) = WTR_UNREG_VARS(IA,SSS) - SUM(G$HDATA(G,'HDINFLOWUREG'), IHYINFUNREG_S(IA,G,SSS));
** If UNREG is negative then deduct from REG
WTR_REG_VARS(IA,SSS)$(IA_HYDROCASA(IA) AND SUM(G, IAGK_HYDRCAS(IA,G)) AND WTR_UNREG_VARS(IA,SSS) < 0) =  WTR_REG_VARS(IA,SSS) + WTR_UNREG_VARS(IA,SSS);
WTR_UNREG_VARS(IA,SSS)$(IA_HYDROCASA(IA) AND SUM(G, IAGK_HYDRCAS(IA,G)) AND WTR_UNREG_VARS(IA,SSS) < 0) = 0;

$offtext
$ontext
** rest of unregulated inflow is added to river storage and short flex
LOOP((IA,G)$(IA_HYDROCASA(IA) AND IAGK_HYDRCAS(IA,G) AND  (HDATA(G,'HDTYPE') EQ RIVER_STORAGE) AND HDATA(G,'HDINFLOWUREG')),
         IHYINFNAT_SLOOP(SSS) = IHYINFUNREG_S(IA,G,SSS);
         WHILE(  (SMAX(SSS, IHYINFNAT_SLOOP(SSS)+ WTR_UNREG_VARS(IA,SSS)*0.2) LT GKFX('2020',IA,G)*CARD(TTT)/1000) AND SUM(SSS,WTR_UNREG_VARS(IA,SSS) > 10) AND (COUNTER(IA,G) <2) AND (IHYINFANN(IA,G)> SUM(SSS, WTR_UNREG_VARS(IA,SSS)*(0.2)*1000)/ GKFX('2020',IA,G)),
                 IHYINFNAT_SLOOP(SSS) = IHYINFNAT_SLOOP(SSS)+ WTR_UNREG_VARS(IA,SSS)*0.2;
                 IHYINFANN(IA,G) = IHYINFANN(IA,G) -  SUM(SSS, WTR_UNREG_VARS(IA,SSS)*0.2*1000)/ GKFX('2020',IA,G);                             !! Deduct from natural inflow as unreg inflow increase
                 WTR_UNREG_VARS(IA,SSS) =  WTR_UNREG_VARS(IA,SSS)*(1-0.2);                                                                              !! Deduct from natural inflow as unreg inflow increase
                 Counter(IA,G) = Counter(IA,G) + 1;
         );
         IHYINFUNREG_S(IA,G,SSS) = IHYINFNAT_SLOOP(SSS);
);
$offtext

** Calculate inflow to power plants:
*IHYINFNAT_S(IA,G,SSS)$(IA_HYDROCASA(IA) AND IAGK_HYDRCAS(IA,G) AND IGHYRS(G) AND NOT HDATA(G,'HDTYPE') EQ FLEX) = (WTR_REG_VARS(IA,SSS) + WTR_UNREG_VARS(IA,SSS)) * GKFX('2020',IA,G) * (IHYINFANN(IA,G)/1000) / SUM(SSSALIAS, WTR_REG_VARS(IA,SSSALIAS) + WTR_UNREG_VARS(IA,SSSALIAS))  ;
*IHYINFUPSTREAM_S(IA,G,SSS)$(IA_HYDROCASA(IA) AND IAGK_HYDRCAS(IA,G) AND IGHYRS(G) AND NOT HDATA(G,'HDTYPE') EQ FLEX) =   WTR_UPSTREAM_VARS(IA,SSS) * GKFX('2020',IA,G) * (IHYINFANN_UPSTREAM(IA,G)/1000) / SUM(SSSALIAS, WTR_UPSTREAM_VARS(IA,SSSALIAS));
