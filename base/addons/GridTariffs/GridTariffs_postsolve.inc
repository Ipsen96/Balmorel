GR_FC_OUTPUT_TECH(Y,IA,IGETOH)  =

* Fixed component and subscribed power (per MW installed)

$ifi %BB4%==yes   IOF1_ *  (

                 + IOF1000 * SUM(IR, SUM(IAGK_HASORPOT(Y,IA,IGETOH)$RRRAAA(IR,IA),

                         IGR_PRICE_TECH(Y,IR,'GRDSUBS')  * (VGKNACCUMNET.L(Y,IA,IGETOH) + GKFX(Y,IA,IGETOH)) /(GDATA(IGETOH,'GDFE') *(1$(NOT GEFFRATE(IA,IGETOH))+GEFFRATE(IA,IGETOH)))     ))

);



GR_EC_OUTPUT_TECH(Y,IA,IGETOH) =

$ifi %BB4%==yes  IOF1_ *  (

* Energy charge winter

                 + SUM(IGR_TIME('GRDECW',IR,IS3,T)$RRRAAA(IR,IA),   SUM((IAGK_HASORPOT(Y,IA,IGETOH)),IHOURSINST(IS3,T) * IGR_PRICE_TECH(Y,IR,'GRDECW')  * VGF_T.L(Y,IA,IGETOH,IS3,T)))

* Energy charge summer

                 + SUM(IGR_TIME('GRDECS',IR,IS3,T)$RRRAAA(IR,IA),   SUM((IAGK_HASORPOT(Y,IA,IGETOH)),IHOURSINST(IS3,T) * IGR_PRICE_TECH(Y,IR,'GRDECS')  * VGF_T.L(Y,IA,IGETOH,IS3,T)))

* Energy charge TOU step 1

                 + SUM(IGR_TIME('GRDTOU1',IR,IS3,T)$RRRAAA(IR,IA),  SUM((IAGK_HASORPOT(Y,IA,IGETOH)),IHOURSINST(IS3,T) * IGR_PRICE_TECH(Y,IR,'GRDTOU1')  * VGF_T.L(Y,IA,IGETOH,IS3,T)))

* Energy charge TOU step 2

                 + SUM(IGR_TIME('GRDTOU2',IR,IS3,T)$RRRAAA(IR,IA),  SUM((IAGK_HASORPOT(Y,IA,IGETOH)),IHOURSINST(IS3,T) * IGR_PRICE_TECH(Y,IR,'GRDTOU2')  * VGF_T.L(Y,IA,IGETOH,IS3,T)))

* Energy charge TOU step 3

                 + SUM(IGR_TIME('GRDTOU3',IR,IS3,T)$RRRAAA(IR,IA),  SUM((IAGK_HASORPOT(Y,IA,IGETOH)),IHOURSINST(IS3,T) * IGR_PRICE_TECH(Y,IR,'GRDTOU3')  * VGF_T.L(Y,IA,IGETOH,IS3,T)))

* Energy charge TOU step 4

                 + SUM(IGR_TIME('GRDTOU4',IR,IS3,T)$RRRAAA(IR,IA),  SUM((IAGK_HASORPOT(Y,IA,IGETOH)),IHOURSINST(IS3,T) * IGR_PRICE_TECH(Y,IR,'GRDTOU4')  * VGF_T.L(Y,IA,IGETOH,IS3,T)))

);



GR_DC_OUTPUT_TECH(Y,IA) =

$ifi %BB4%==yes   IOF1_ *  (

* Demand charge winter

                 + IOF1000 * SUM((IR,MMM)$(RRRAAA(IR,IA) AND SUM((IS3,T)$IGR_TIME('GRDDCW',IR,IS3,T), ISSSTTTMMM(IS3,T,MMM))), VGETOH_CAP1.L(Y,IA,MMM) *  IGR_PRICE_TECH(Y,IR,'GRDDCW'))/(IGR_MONTHSINSIM/card(MMM))    !! Demand charge winter

* Demand charge summer

                 + IOF1000 * SUM((IR,MMM)$(RRRAAA(IR,IA) AND SUM((IS3,T)$IGR_TIME('GRDDCS',IR,IS3,T), ISSSTTTMMM(IS3,T,MMM))), VGETOH_CAP1.L(Y,IA,MMM) *  IGR_PRICE_TECH(Y,IR,'GRDDCS'))/(IGR_MONTHSINSIM/card(MMM))    !! Demand charge summer

* Demand charge 2 (e.g for spring and fall months)

                 + IOF1000 * SUM((IR,MMM)$(RRRAAA(IR,IA) AND SUM((IS3,T)$IGR_TIME('GRDDC2',IR,IS3,T), ISSSTTTMMM(IS3,T,MMM))), VGETOH_CAP1.L(Y,IA,MMM) *  IGR_PRICE_TECH(Y,IR,'GRDDC2'))/(IGR_MONTHSINSIM/card(MMM))    !! Demand charge 2

* Demand charge TOU

                 + IOF1000 * SUM((IR,MMM)$RRRAAA(IR,IA),   VGETOH_CAP2.L(Y,IA,MMM) *  IGR_PRICE_TECH(Y,IR,'GRDDCTOU'))/(IGR_MONTHSINSIM/card(MMM))

* Demand charge yearly

                 + IOF1000 * SUM(IR$RRRAAA(IR,IA),   VGETOH_CAPY.L(Y,IA) *  IGR_PRICE_TECH(Y,IR,'GRDDCY'))

);



GR_EC_OUTPUT_USER(y,IR,DEUSER) =

$ifi %BB4%==yes  IOF1_ *  (

* Tariffs on user groups

                 + SUM((IS3,T)$IGR_TIME('GRDECW',IR,IS3,T),   IHOURSINST(IS3,T) * IGR_PRICE_DEUSER(Y,IR,DEUSER,'GRDECW')  * ( ((DE(Y,IR,DEUSER) * DE_VAR_T(IR,DEUSER,IS3,T)) / IDE_SUMST(IR,DEUSER))$(IDE_SUMST(IR,DEUSER) GT 0)) )

                 + SUM((IS3,T)$IGR_TIME('GRDECS',IR,IS3,T),   IHOURSINST(IS3,T) * IGR_PRICE_DEUSER(Y,IR,DEUSER,'GRDECS')  * ( ((DE(Y,IR,DEUSER) * DE_VAR_T(IR,DEUSER,IS3,T)) / IDE_SUMST(IR,DEUSER))$(IDE_SUMST(IR,DEUSER) GT 0)) )

                 + SUM((IS3,T)$IGR_TIME('GRDTOU1',IR,IS3,T),  IHOURSINST(IS3,T) * IGR_PRICE_DEUSER(Y,IR,DEUSER,'GRDTOU1') * ( ((DE(Y,IR,DEUSER) * DE_VAR_T(IR,DEUSER,IS3,T)) / IDE_SUMST(IR,DEUSER))$(IDE_SUMST(IR,DEUSER) GT 0)) )

                 + SUM((IS3,T)$IGR_TIME('GRDTOU2',IR,IS3,T),  IHOURSINST(IS3,T) * IGR_PRICE_DEUSER(Y,IR,DEUSER,'GRDTOU2') * ( ((DE(Y,IR,DEUSER) * DE_VAR_T(IR,DEUSER,IS3,T)) / IDE_SUMST(IR,DEUSER))$(IDE_SUMST(IR,DEUSER) GT 0)) )

                 + SUM((IS3,T)$IGR_TIME('GRDTOU3',IR,IS3,T),  IHOURSINST(IS3,T) * IGR_PRICE_DEUSER(Y,IR,DEUSER,'GRDTOU3') * ( ((DE(Y,IR,DEUSER) * DE_VAR_T(IR,DEUSER,IS3,T)) / IDE_SUMST(IR,DEUSER))$(IDE_SUMST(IR,DEUSER) GT 0)) )

                 + SUM((IS3,T)$IGR_TIME('GRDTOU4',IR,IS3,T),  IHOURSINST(IS3,T) * IGR_PRICE_DEUSER(Y,IR,DEUSER,'GRDTOU4') * ( ((DE(Y,IR,DEUSER) * DE_VAR_T(IR,DEUSER,IS3,T)) / IDE_SUMST(IR,DEUSER))$(IDE_SUMST(IR,DEUSER) GT 0)) )



$ifi not %DemandResponse%==yes  $goto label_GridTariffs_postsolve_DR_END

                 + SUM((IS3,T)$IGR_TIME('GRDECW',IR,IS3,T),   SUM((IA,DR_TECH)$(IADR(Y,IA,DR_TECH) AND RRRAAA(IR,IA) AND DR_TECH_USER(DR_TECH,DEUSER)),IHOURSINST(IS3,T) * IGR_PRICE_DEUSER(Y,IR,DEUSER,'GRDECS')  * (VDR_UP.L(Y,IA,DR_TECH,IS3,T) - VDR_DOWN.L(Y,IA,DR_TECH,IS3,T))))

                 + SUM((IS3,T)$IGR_TIME('GRDECS',IR,IS3,T),   SUM((IA,DR_TECH)$(IADR(Y,IA,DR_TECH) AND RRRAAA(IR,IA) AND DR_TECH_USER(DR_TECH,DEUSER)),IHOURSINST(IS3,T) * IGR_PRICE_DEUSER(Y,IR,DEUSER,'GRDECS')  * (VDR_UP.L(Y,IA,DR_TECH,IS3,T) - VDR_DOWN.L(Y,IA,DR_TECH,IS3,T))))

                 + SUM((IS3,T)$IGR_TIME('GRDTOU1',IR,IS3,T),  SUM((IA,DR_TECH)$(IADR(Y,IA,DR_TECH) AND RRRAAA(IR,IA) AND DR_TECH_USER(DR_TECH,DEUSER)),IHOURSINST(IS3,T) * IGR_PRICE_DEUSER(Y,IR,DEUSER,'GRDTOU1') * (VDR_UP.L(Y,IA,DR_TECH,IS3,T) - VDR_DOWN.L(Y,IA,DR_TECH,IS3,T) )))

                 + SUM((IS3,T)$IGR_TIME('GRDTOU2',IR,IS3,T),  SUM((IA,DR_TECH)$(IADR(Y,IA,DR_TECH) AND RRRAAA(IR,IA) AND DR_TECH_USER(DR_TECH,DEUSER)),IHOURSINST(IS3,T) * IGR_PRICE_DEUSER(Y,IR,DEUSER,'GRDTOU2') * (VDR_UP.L(Y,IA,DR_TECH,IS3,T) - VDR_DOWN.L(Y,IA,DR_TECH,IS3,T))))

                 + SUM((IS3,T)$IGR_TIME('GRDTOU3',IR,IS3,T),  SUM((IA,DR_TECH)$(IADR(Y,IA,DR_TECH) AND RRRAAA(IR,IA) AND DR_TECH_USER(DR_TECH,DEUSER)),IHOURSINST(IS3,T) * IGR_PRICE_DEUSER(Y,IR,DEUSER,'GRDTOU3') * (VDR_UP.L(Y,IA,DR_TECH,IS3,T) - VDR_DOWN.L(Y,IA,DR_TECH,IS3,T) )))

                 + SUM((IS3,T)$IGR_TIME('GRDTOU4',IR,IS3,T),  SUM((IA,DR_TECH)$(IADR(Y,IA,DR_TECH) AND RRRAAA(IR,IA) AND DR_TECH_USER(DR_TECH,DEUSER)),IHOURSINST(IS3,T) * IGR_PRICE_DEUSER(Y,IR,DEUSER,'GRDTOU4') * (VDR_UP.L(Y,IA,DR_TECH,IS3,T) - VDR_DOWN.L(Y,IA,DR_TECH,IS3,T) )))



$LABEL label_GridTariffs_postsolve_DR_END

);



$ifi not %EV%==yes  $goto label_GridTariffs_postsolve_EV_END

** EV's are assumed to be in the residential user group

GR_EC_OUTPUT_USER(Y,IR,'RESE') = GR_EC_OUTPUT_USER(Y,IR,'RESE') +

$ifi %BB4%==yes  IOF1_ *  (

                 + SUM((IS3,T)$IGR_TIME('GRDECW',IR,IS3,T),  IHOURSINST(IS3,T) * IGR_PRICE_DEUSER(Y,IR,'RESE','GRDECW')   * (VEV_VNETCHARGE_BEV.L(Y,IR,IS3,T) + VEV_VNETCHARGE_PHEV.L(Y,IR,IS3,T) - VEV_VNETDISCHARGE_BEV.L(Y,IR,IS3,T) - VEV_VNETDISCHARGE_PHEV.L(Y,IR,IS3,T)))

                 + SUM((IS3,T)$IGR_TIME('GRDECS',IR,IS3,T),  IHOURSINST(IS3,T) * IGR_PRICE_DEUSER(Y,IR,'RESE','GRDECS')   * (VEV_VNETCHARGE_BEV.L(Y,IR,IS3,T) + VEV_VNETCHARGE_PHEV.L(Y,IR,IS3,T) - VEV_VNETDISCHARGE_BEV.L(Y,IR,IS3,T) - VEV_VNETDISCHARGE_PHEV.L(Y,IR,IS3,T)))

                 + SUM((IS3,T)$IGR_TIME('GRDTOU1',IR,IS3,T), IHOURSINST(IS3,T) * IGR_PRICE_DEUSER(Y,IR,'RESE','GRDTOU1')  * (VEV_VNETCHARGE_BEV.L(Y,IR,IS3,T) + VEV_VNETCHARGE_PHEV.L(Y,IR,IS3,T) - VEV_VNETDISCHARGE_BEV.L(Y,IR,IS3,T) - VEV_VNETDISCHARGE_PHEV.L(Y,IR,IS3,T)))

                 + SUM((IS3,T)$IGR_TIME('GRDTOU2',IR,IS3,T), IHOURSINST(IS3,T) * IGR_PRICE_DEUSER(Y,IR,'RESE','GRDTOU2')  * (VEV_VNETCHARGE_BEV.L(Y,IR,IS3,T) + VEV_VNETCHARGE_PHEV.L(Y,IR,IS3,T) - VEV_VNETDISCHARGE_BEV.L(Y,IR,IS3,T) - VEV_VNETDISCHARGE_PHEV.L(Y,IR,IS3,T)))

                 + SUM((IS3,T)$IGR_TIME('GRDTOU3',IR,IS3,T), IHOURSINST(IS3,T) * IGR_PRICE_DEUSER(Y,IR,'RESE','GRDTOU3')  * (VEV_VNETCHARGE_BEV.L(Y,IR,IS3,T) + VEV_VNETCHARGE_PHEV.L(Y,IR,IS3,T) - VEV_VNETDISCHARGE_BEV.L(Y,IR,IS3,T) - VEV_VNETDISCHARGE_PHEV.L(Y,IR,IS3,T)))

                 + SUM((IS3,T)$IGR_TIME('GRDTOU4',IR,IS3,T), IHOURSINST(IS3,T) * IGR_PRICE_DEUSER(Y,IR,'RESE','GRDTOU4')  * (VEV_VNETCHARGE_BEV.L(Y,IR,IS3,T) + VEV_VNETCHARGE_PHEV.L(Y,IR,IS3,T) - VEV_VNETDISCHARGE_BEV.L(Y,IR,IS3,T) - VEV_VNETDISCHARGE_PHEV.L(Y,IR,IS3,T)))

);

$LABEL label_GridTariffs_postsolve_EV_END





GR_DC_OUTPUT_USER(Y,IR,DEUSER) =

$ifi %BB4%==yes  IOF1_ *  (

                 + IOF1000 * SUM(MMM$(SUM((IS3,T)$IGR_TIME('GRDDCW',IR,IS3,T), ISSSTTTMMM(IS3,T,MMM))), VDEUSER_CAP1.L(Y,IR,DEUSER,MMM) *  IGR_PRICE_DEUSER(Y,IR,DEUSER,'GRDDCW'))/(IGR_MONTHSINSIM/CARD(MMM))    !! Demand charge winter

                 + IOF1000 * SUM(MMM$(SUM((IS3,T)$IGR_TIME('GRDDCS',IR,IS3,T), ISSSTTTMMM(IS3,T,MMM))), VDEUSER_CAP1.L(Y,IR,DEUSER,MMM) *  IGR_PRICE_DEUSER(Y,IR,DEUSER,'GRDDCS'))/(IGR_MONTHSINSIM/CARD(MMM))    !! Demand charge summer

                 + IOF1000 * SUM(MMM$(SUM((IS3,T)$IGR_TIME('GRDDC2',IR,IS3,T), ISSSTTTMMM(IS3,T,MMM))), VDEUSER_CAP1.L(Y,IR,DEUSER,MMM) *  IGR_PRICE_DEUSER(Y,IR,DEUSER,'GRDDC2'))/(IGR_MONTHSINSIM/CARD(MMM))    !! Demand charge 2

                 + IOF1000 * SUM(MMM,   VDEUSER_CAP2.L(Y,IR,DEUSER,MMM) *  IGR_PRICE_DEUSER(Y,IR,DEUSER,'GRDDCTOU'))/(IGR_MONTHSINSIM/card(MMM))

                 + IOF1000 * VDEUSER_CAPY.L(Y,IR,DEUSER) *  IGR_PRICE_DEUSER(Y,IR,DEUSER,'GRDDCY')

);



EXECUTE_UNLOAD "%relpathoutput%temp/GR_OUT.GDX", GR_FC_OUTPUT_TECH, GR_EC_OUTPUT_TECH, GR_DC_OUTPUT_TECH, GR_EC_OUTPUT_USER, GR_DC_OUTPUT_USER;
